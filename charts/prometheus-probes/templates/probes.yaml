{{- $releaseNamespace := .Release.Namespace }}
{{- $prober := .Values.prober }}
{{- range .Values.environments }}
{{- $hasAuth := hasSuffix "-with-auth" .name }}
---
apiVersion: monitoring.coreos.com/v1
kind: Probe
metadata:
  name: "blackbox-exporter-{{ .name }}"
  namespace: {{ $releaseNamespace }}
  labels:
{{- if $hasAuth }}
    environment: {{ trimSuffix "-with-auth" .name }}
{{- else }}
    environment: {{ .name }}
{{- end }}
spec:
  jobName: http-get
  interval: 60s
{{- if $hasAuth }}
  # Use the http_401 module for endpoints that require authentication,
  # expecting a 401 Unauthorized response
  module: http_401
{{- else }}
  module: http_2xx
{{- end }}
  prober:
    url: "{{ $prober.url }}:{{ $prober.port | default 9115 }}"
    scheme: {{ $prober.scheme | default "http" }}
    path: {{ $prober.path | default "/probe" }}
  targets:
    staticConfig:
      static:
    {{- range .targets }}
      - {{ . }}
    {{- end }}
{{- end }}

{{- $fullName := include "chorus-ci.fullname" . -}}
{{- $serviceAccountName := include "chorus-ci.serviceAccountName" . -}}
{{- $githubSecretName := index .Values.githubSecrets "chorus-backend" }}
{{- $backendAcceptanceTestsReleaseName := "acceptance" -}}
---
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: {{ $fullName }}-chorus-backend-ci-workflow-template
  labels:
    {{- include "chorus-ci.labels" . | nindent 4 }}
spec:
  serviceAccountName: {{ $serviceAccountName }}
  entrypoint: go-test

  arguments:
    parameters:
      - name: repoUrl
      - name: repoFullName
      - name: ref
      - name: sha
      - name: tag
      - name: repository
        value: {{ .Values.chorusBackend.acceptanceRepository | quote }}
      - name: addLatestTag
        value: "false"

  volumeClaimTemplates:
    - metadata:
        name: docker-data
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: {{ .Values.chorusBackend.dockerDataStorage.storageRequest | default .Values.workflow.dockerDataStorage.storageRequest | quote }}
        storageClassName: {{ .Values.chorusBackend.dockerDataStorage.storageClassName | default .Values.workflow.dockerDataStorage.storageClassName | quote }}

  templates:
    - name: go-test
      steps:
        - - name: stop-previous-workflows
            templateRef:
              name: {{ $fullName }}-stop-previous-workflows-template
              template: stop-previous-workflows
            arguments:
              parameters:
                - name: repo
                  value: "{{`{{workflow.labels.repo}}`}}"
                - name: ref
                  value: "{{`{{workflow.labels.ref}}`}}"
        - - name: run-tests
            template: test
        - - name: run-acceptance-tests
            template: acceptance-tests

    - name: test
      inputs:
        artifacts:
          - name: git
            path: "/src"
            git:
              repo: "{{`{{workflow.parameters.repoUrl}}`}}"
              revision: "{{`{{workflow.parameters.sha}}`}}"
              usernameSecret:
                name: {{ $githubSecretName }}
                key: username
              passwordSecret:
                name: {{ $githubSecretName }}
                key: password
              ref: "{{`{{workflow.parameters.ref}}`}}"
      volumes:
        - name: github-secret
          secret:
            secretName: {{ $githubSecretName }}
      container:
        env:
          - name: GIT_USERNAME
            valueFrom:
              secretKeyRef:
                name: {{ $githubSecretName }}
                key: username
          - name: GIT_PASSWORD
            valueFrom:
              secretKeyRef:
                name: {{ $githubSecretName }}
                key: password
        image: {{ .Values.chorusBackend.golang.imageDomain | default .Values.global.imageDomain }}/{{ .Values.chorusBackend.golang.imageNamespace | default .Values.global.imageNamespace }}/golang:{{ .Values.chorusBackend.golang.tag | default "latest" }}
        command: [sh, -e, -c]
        args:
          - >
            GOPRIVATE=github.com/CHORUS-TRE/*
            GIT_CONFIG_COUNT=1
            GIT_CONFIG_KEY_0=url."https://${GIT_USERNAME}:${GIT_PASSWORD}@github.com/".insteadOf
            GIT_CONFIG_VALUE_0=https://github.com/
            go test -v ./...
        workingDir: "/src"
    - name: acceptance-tests
      steps:
        - - name: docker-build
            templateRef:
              name: {{ $fullName }}-docker-build-template
              template: docker-build
            arguments:
              parameters:
                - name: image
                  value: "backend"
                - name: tag
                  value: "{{`{{workflow.parameters.tag}}`}}"
                - name: sha
                  value: "{{`{{workflow.parameters.sha}}`}}"
                - name: dockerfile
                  value: "docker/dockerfiles/backend.dockerfile"
                - name: repository
                  value: "{{`{{workflow.parameters.repository}}`}}"
                - name: registry
                  value: {{ .Values.sensor.registry | quote }}
                - name: dockerConfigSecret
                  value: {{ .Values.sensor.dockerConfig.secretName | quote }}
                - name: gitSecretName
                  value: {{ $githubSecretName | quote }}
                - name: addLatestTag
                  value: "{{`{{workflow.parameters.addLatestTag}}`}}"
              artifacts:
                - name: source
                  git:
                    repo: "{{`{{workflow.parameters.repoUrl}}`}}"
                    revision: "{{`{{workflow.parameters.sha}}`}}"
                    usernameSecret:
                      name: {{ $githubSecretName }}
                      key: username
                    passwordSecret:
                      name: {{ $githubSecretName }}
                      key: password
                    depth: 1
                    ref: "{{`{{workflow.parameters.ref}}`}}"
        - - name: backend-acceptance-tests
            templateRef:
              name: {{ $fullName }}-backend-acceptance-tests-workflow-template
              template: main
            hooks:
              exit:
                templateRef:
                  name: {{ $fullName }}-backend-acceptance-tests-workflow-template
                  template: cleanup-namespace
                arguments:
                  parameters:
                    - name: chorusBackendAcceptanceNamespace
                      value: {{ .Values.chorusBackend.acceptanceTestsNamespace }}
                    - name: releaseName
                      value: "{{ $backendAcceptanceTestsReleaseName }}-{{`{{=sprig.trunc(8, workflow.uid)}}`}}"
            arguments:
              parameters:
                - name: githubSecretName
                  value: {{ $githubSecretName }}
                - name: releaseName
                  value: "{{ $backendAcceptanceTestsReleaseName }}-{{`{{=sprig.trunc(8, workflow.uid)}}`}}"
                - name: chorusBackendAcceptanceNamespace
                  value: {{ .Values.chorusBackend.acceptanceTestsNamespace }}
                - name: chorusBackendImageTag
                  value: "{{`{{steps.docker-build.outputs.parameters.imageVersion}}`}}"
              artifacts:
                - name: source
                  git:
                    repo: "{{`{{workflow.parameters.repoUrl}}`}}"
                    revision: "{{`{{workflow.parameters.sha}}`}}"
                    usernameSecret:
                      name: {{ $githubSecretName }}
                      key: username
                    passwordSecret:
                      name: {{ $githubSecretName }}
                      key: password
                    depth: 1
                    ref: "{{`{{workflow.parameters.ref}}`}}"

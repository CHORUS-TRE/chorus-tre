{{- $fullName := include "chorus-ci.fullname" . -}}
{{- $serviceAccountName := include "chorus-ci.serviceAccountName" . -}}
{{- $githubSecretName := index .Values.githubSecrets "chorus-backend" }}
{{- $backendAcceptanceTestsReleaseName := "acceptance" -}}
---
apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: {{ $fullName }}-build-chorus-backend
  labels:
    {{- include "chorus-ci.labels" . | nindent 4 }}
spec:
  eventBusName: {{ $fullName }}-default
  template:
    serviceAccountName: {{ $serviceAccountName }}
  dependencies:
    - name: build-chorus-backend
      eventSourceName: {{ $fullName }}-github
      eventName: chorus-backend
      filters:
        data:
          - path: headers.X-Github-Event
            type: string
            value:
              - push
          - path: "body.ref"
            type: string
            value:
              # The goal is to publish tagged releases.
              #- "refs/heads/master"
              - "refs/tags/v*"

    - name: ci-chorus-backend
      eventSourceName: {{ $fullName }}-github
      eventName: chorus-backend
      filters:
        data:
          - path: headers.X-Github-Event
            type: string
            value:
              - pull_request
          - path: "body.action"
            type: string
            value:
              - "opened"
              - "synchronize"

    - name: master-chorus-backend
      eventSourceName: {{ $fullName }}-github
      eventName: chorus-backend
      filters:
        data:
          - path: headers.X-Github-Event
            type: string
            value:
              - push
          - path: "body.ref"
            type: string
            value:
              - "refs/heads/master"

  triggers:
    - template:
        conditions: ci-chorus-backend
        name: github-workflow-trigger-ci-chorus-backend
        k8s:
          operation: create
          source:
            resource:
              apiVersion: argoproj.io/v1alpha1
              kind: Workflow
              metadata:
                generateName: "-"
              spec:
                arguments:
                  parameters:
                    - name: repoUrl
                    - name: repoFullName
                    - name: ref
                    - name: sha
                    - name: tag
                    - name: repository
                      value: {{ .Values.chorusBackend.acceptanceRepository | quote }}

                hooks:
                  running:
                    expression: workflow.status == "Running"
                    templateRef:
                      name: {{ $fullName }}-github-notify-template
                      template: github-notify
                    arguments:
                      parameters:
                        - name: repoFullName
                          value: "{{`{{workflow.parameters.repoFullName}}`}}"
                        - name: sha
                          value: "{{`{{workflow.parameters.sha}}`}}"
                        - name: githubSecret
                          value: {{ $githubSecretName }}
                  exit:
                    templateRef:
                      name: {{ $fullName }}-github-notify-template
                      template: github-notify
                    arguments:
                      parameters:
                        - name: repoFullName
                          value: "{{`{{workflow.parameters.repoFullName}}`}}"
                        - name: sha
                          value: "{{`{{workflow.parameters.sha}}`}}"
                        - name: githubSecret
                          value: {{ $githubSecretName }}

                workflowTemplateRef:
                  name: {{ $fullName }}-chorus-backend-ci-workflow-template

          parameters:
            - src:
                dependencyName: ci-chorus-backend
                dataKey: body.repository.clone_url
              dest: spec.arguments.parameters.0.value
            - src:
                dependencyName: ci-chorus-backend
                dataKey: body.repository.full_name
              dest: spec.arguments.parameters.1.value
            - src:
                dependencyName: ci-chorus-backend
                dataKey: body.pull_request.head.ref
              dest: spec.arguments.parameters.2.value
            - src:
                dependencyName: ci-chorus-backend
                dataKey: body.pull_request.head.sha
              dest: spec.arguments.parameters.3.value
            - src:
                dependencyName: ci-chorus-backend
                dataTemplate: "pr-{{`{{ .Input.body.pull_request.number }}`}}-{{`{{ .Input.body.pull_request.head.sha | substr 0 7 }}`}}"
              dest: spec.arguments.parameters.4.value
            # Append text and commit id to dynamically assign workflow name.
            - src:
                dependencyName: ci-chorus-backend
                dataTemplate: "ci-chorus-backend-pr{{`{{ .Input.body.pull_request.number }}`}}"
              dest: metadata.generateName
              operation: prepend
            # Generate a nice title and description
            - src:
                dependencyName: ci-chorus-backend
                dataTemplate: "CI {{`{{ .Input.body.repository.full_name }}`}}"
              dest: metadata.annotations.workflows\.argoproj\.io/title
            - src:
                dependencyName: ci-chorus-backend
                dataTemplate: "PR #{{`{{ .Input.body.pull_request.number }}`}} - {{`{{ .Input.body.pull_request.head.ref }}`}}"
              dest: metadata.annotations.workflows\.argoproj\.io/description
            # Set labels for use by stop-previous-workflows
            - src:
                dependencyName: ci-chorus-backend
                dataTemplate: '{{`{{ .Input.body.repository.full_name | replace "/" "-" }}`}}'
              dest: metadata.labels.repo
            - src:
                dependencyName: ci-chorus-backend
                dataTemplate: '{{`{{ .Input.body.pull_request.head.ref | replace "/" "-" }}`}}'
              dest: metadata.labels.ref

    - template:
        conditions: master-chorus-backend
        name: github-workflow-trigger-ci-master-chorus-backend
        k8s:
          operation: create
          source:
            resource:
              apiVersion: argoproj.io/v1alpha1
              kind: Workflow
              metadata:
                generateName: "-"
              spec:
                arguments:
                  parameters:
                    - name: repoUrl
                    - name: repoFullName
                    - name: ref
                    - name: sha
                    - name: tag
                    - name: repository
                      value: {{ .Values.chorusBackend.acceptanceRepository | quote }}

                hooks:
                  running:
                    expression: workflow.status == "Running"
                    templateRef:
                      name: {{ $fullName }}-github-notify-template
                      template: github-notify
                    arguments:
                      parameters:
                        - name: repoFullName
                          value: "{{`{{workflow.parameters.repoFullName}}`}}"
                        - name: sha
                          value: "{{`{{workflow.parameters.sha}}`}}"
                        - name: githubSecret
                          value: {{ $githubSecretName }}
                  exit:
                    templateRef:
                      name: {{ $fullName }}-github-notify-template
                      template: github-notify
                    arguments:
                      parameters:
                        - name: repoFullName
                          value: "{{`{{workflow.parameters.repoFullName}}`}}"
                        - name: sha
                          value: "{{`{{workflow.parameters.sha}}`}}"
                        - name: githubSecret
                          value: {{ $githubSecretName }}

                workflowTemplateRef:
                  name: {{ $fullName }}-chorus-backend-ci-workflow-template

          parameters:
            - src:
                dependencyName: master-chorus-backend
                dataKey: body.repository.clone_url
              dest: spec.arguments.parameters.0.value
            - src:
                dependencyName: master-chorus-backend
                dataKey: body.repository.full_name
              dest: spec.arguments.parameters.1.value
            - src:
                dependencyName: master-chorus-backend
                dataKey: body.ref
              dest: spec.arguments.parameters.2.value
            - src:
                dependencyName: master-chorus-backend
                dataKey: body.head_commit.id
              dest: spec.arguments.parameters.3.value
            - src:
                dependencyName: master-chorus-backend
                dataTemplate: "master-{{`{{ .Input.body.head_commit.id | substr 0 7 }}`}}"
              dest: spec.arguments.parameters.4.value
            # Append text and commit id to dynamically assign workflow name.
            - src:
                dependencyName: master-chorus-backend
                dataTemplate: "master-chorus-backend-{{`{{ .Input.body.head_commit.id | substr 0 7 }}`}}"
              dest: metadata.generateName
              operation: prepend
            # Generate a nice title and description
            - src:
                dependencyName: master-chorus-backend
                dataTemplate: "CI Master {{`{{ .Input.body.repository.full_name }}`}}"
              dest: metadata.annotations.workflows\.argoproj\.io/title
            - src:
                dependencyName: master-chorus-backend
                dataTemplate: "Master - {{`{{ .Input.body.head_commit.message }}`}}"
              dest: metadata.annotations.workflows\.argoproj\.io/description
            # Set labels for use by stop-previous-workflows
            - src:
                dependencyName: master-chorus-backend
                dataTemplate: '{{`{{ .Input.body.repository.full_name | replace "/" "-" }}`}}'
              dest: metadata.labels.repo
            - src:
                dependencyName: master-chorus-backend
                dataTemplate: "master"
              dest: metadata.labels.ref

    - template:
        conditions: master-chorus-backend
        name: github-workflow-trigger-build-master-chorus-backend
        k8s:
          operation: create
          source:
            resource:
              apiVersion: argoproj.io/v1alpha1
              kind: Workflow
              metadata:
                generateName: "-"
              spec:
                arguments:
                  parameters:
                    - name: repoUrl
                    - name: repoFullName
                    - name: ref
                    - name: sha
                    - name: tag
                    - name: repository
                      value: {{ .Values.chorusBackend.masterRepository | quote }}
                    - name: addLatestTag
                      value: "true"

                hooks:
                  running:
                    expression: workflow.status == "Running"
                    templateRef:
                      name: {{ $fullName }}-github-notify-template
                      template: github-notify
                    arguments:
                      parameters:
                        - name: repoFullName
                          value: "{{`{{workflow.parameters.repoFullName}}`}}"
                        - name: sha
                          value: "{{`{{workflow.parameters.sha}}`}}"
                        - name: githubSecret
                          value: {{ $githubSecretName }}
                  exit:
                    templateRef:
                      name: {{ $fullName }}-github-notify-template
                      template: github-notify
                    arguments:
                      parameters:
                        - name: repoFullName
                          value: "{{`{{workflow.parameters.repoFullName}}`}}"
                        - name: sha
                          value: "{{`{{workflow.parameters.sha}}`}}"
                        - name: githubSecret
                          value: {{ $githubSecretName }}

                templates:
                  - templateRef:
                      name: {{ $fullName }}-docker-build-template
                      template: docker-build
                    arguments:
                      parameters:
                        - name: image
                          value: "backend"
                        - name: tag
                          value: "{{`{{workflow.parameters.tag}}`}}"
                        - name: sha
                          value: "{{`{{workflow.parameters.sha}}`}}"
                        - name: dockerfile
                          value: "docker/dockerfiles/backend.dockerfile"
                        - name: repository
                          value: {{ .Values.chorusBackend.masterRepository | quote }}
                        - name: registry
                          value: {{ .Values.sensor.registry | quote }}
                        - name: dockerConfigSecret
                          value: {{ .Values.sensor.dockerConfig.secretName | quote }}
                        - name: gitSecretName
                          value: {{ $githubSecretName | quote }}
                        - name: addLatestTag
                          value: "true"
                      artifacts:
                        - name: source
                          git:
                            repo: "{{`{{workflow.parameters.repoUrl}}`}}"
                            revision: "{{`{{workflow.parameters.sha}}`}}"
                            usernameSecret:
                              name: {{ $githubSecretName }}
                              key: username
                            passwordSecret:
                              name: {{ $githubSecretName }}
                              key: password
                            depth: 1
                            ref: "{{`{{workflow.parameters.ref}}`}}"

          parameters:
            - src:
                dependencyName: master-chorus-backend
                dataKey: body.repository.clone_url
              dest: spec.arguments.parameters.0.value
            - src:
                dependencyName: master-chorus-backend
                dataKey: body.repository.full_name
              dest: spec.arguments.parameters.1.value
            - src:
                dependencyName: master-chorus-backend
                dataKey: body.ref
              dest: spec.arguments.parameters.2.value
            - src:
                dependencyName: master-chorus-backend
                dataKey: body.head_commit.id
              dest: spec.arguments.parameters.3.value
            - src:
                dependencyName: master-chorus-backend
                dataTemplate: "master-{{`{{ .Input.body.head_commit.id | substr 0 7 }}`}}"
              dest: spec.arguments.parameters.4.value
            # Append text and commit id to dynamically assign workflow name.
            - src:
                dependencyName: master-chorus-backend
                dataTemplate: "master-chorus-backend-{{`{{ .Input.body.head_commit.id | substr 0 7 }}`}}"
              dest: metadata.generateName
              operation: prepend
            # Generate a nice title and description
            - src:
                dependencyName: master-chorus-backend
                dataTemplate: "CI Master {{`{{ .Input.body.repository.full_name }}`}}"
              dest: metadata.annotations.workflows\.argoproj\.io/title
            - src:
                dependencyName: master-chorus-backend
                dataTemplate: "Master - {{`{{ .Input.body.head_commit.message }}`}}"
              dest: metadata.annotations.workflows\.argoproj\.io/description
            # Set labels for use by stop-previous-workflows
            - src:
                dependencyName: master-chorus-backend
                dataTemplate: '{{`{{ .Input.body.repository.full_name | replace "/" "-" }}`}}'
              dest: metadata.labels.repo
            - src:
                dependencyName: master-chorus-backend
                dataTemplate: "master"
              dest: metadata.labels.ref

    - template:
        conditions: build-chorus-backend
        name: github-workflow-trigger-chorus-backend
        k8s:
          operation: create
          source:
            resource:
              apiVersion: argoproj.io/v1alpha1
              kind: Workflow
              metadata:
                generateName: "-"
              spec:
                serviceAccountName: {{ $serviceAccountName }}
                entrypoint: build-chorus-backend

                volumeClaimTemplates:
                  - metadata:
                      name: docker-data
                    spec:
                      accessModes: ["ReadWriteOnce"]
                      resources:
                        requests:
                          storage: {{ .Values.chorusBackend.dockerDataStorage.storageRequest | default .Values.workflow.dockerDataStorage.storageRequest | quote }}
                      storageClassName: {{ .Values.chorusBackend.dockerDataStorage.storageClassName | default .Values.workflow.dockerDataStorage.storageClassName | quote }}

                volumes:
                  - name: docker-config
                    secret:
                      secretName: {{ .Values.sensor.dockerConfig.secretName | quote }}
                      items:
                        - key: .dockerconfigjson
                          path: config.json

                arguments:
                  parameters:
                    - name: repoUrl
                    - name: repoFullName
                    - name: revision
                    - name: ref
                    - name: sha
                    - name: tag

                hooks:
                  running:
                    expression: workflow.status == "Running"
                    templateRef:
                      name: {{ $fullName }}-github-notify-template
                      template: github-notify
                    arguments:
                      parameters:
                        - name: repoFullName
                          value: "{{`{{workflow.parameters.repoFullName}}`}}"
                        - name: sha
                          value: "{{`{{workflow.parameters.sha}}`}}"
                        - name: githubSecret
                          value: {{ $githubSecretName }}

                  exit:
                    templateRef:
                      name: {{ $fullName }}-github-notify-template
                      template: github-notify
                    arguments:
                      parameters:
                        - name: repoFullName
                          value: "{{`{{workflow.parameters.repoFullName}}`}}"
                        - name: sha
                          value: "{{`{{workflow.parameters.sha}}`}}"
                        - name: githubSecret
                          value: {{ $githubSecretName }}

                templates:
                  - name: build-chorus-backend
                    steps:
                      - - name: docker-build
                          templateRef:
                            name: {{ $fullName }}-docker-build-template
                            template: docker-build
                          arguments:
                            parameters:
                              - name: image
                                value: "backend"
                              - name: tag
                                value: "{{`{{workflow.parameters.tag}}`}}"
                              - name: sha
                                value: "{{`{{workflow.parameters.sha}}`}}"
                              - name: dockerfile
                                value: "docker/dockerfiles/backend.dockerfile"
                              - name: repository
                                value: "chorus"
                              - name: registry
                                value: {{ .Values.sensor.registry | quote }}
                              - name: dockerConfigSecret
                                value: {{ .Values.sensor.dockerConfig.secretName | quote }}
                              - name: gitSecretName
                                value: {{ $githubSecretName | quote }}
                            artifacts:
                              - name: source
                                git:
                                  repo: "{{`{{workflow.parameters.repoUrl}}`}}"
                                  revision: "{{`{{workflow.parameters.revision}}`}}"
                                  usernameSecret:
                                    name: {{ $githubSecretName }}
                                    key: username
                                  passwordSecret:
                                    name: {{ $githubSecretName }}
                                    key: password
                                  depth: 1
                                  ref: "{{`{{workflow.parameters.ref}}`}}"

                      - - name: helm-publish
                          templateRef:
                            name: {{ $fullName }}-helm-publish-template
                            template: helm-publish
                          arguments:
                            parameters:
                              - name: chartsDir
                                value: "deploy"
                              - name: chartName
                                value: "backend"
                              - name: registry
                                value: {{ .Values.sensor.registry | quote }}
                              - name: dockerConfigSecret
                                value: {{ .Values.sensor.dockerConfig.secretName | quote }}
                            artifacts:
                              - name: source
                                git:
                                  repo: "{{`{{workflow.parameters.repoUrl}}`}}"
                                  revision: "{{`{{workflow.parameters.revision}}`}}"
                                  usernameSecret:
                                    name: {{ $githubSecretName }}
                                    key: username
                                  passwordSecret:
                                    name: {{ $githubSecretName }}
                                    key: password
                                  depth: 1
                                  ref: "{{`{{workflow.parameters.ref}}`}}"

          parameters:
            - src:
                dependencyName: build-chorus-backend
                dataKey: body.repository.clone_url
              dest: spec.arguments.parameters.0.value
            - src:
                dependencyName: build-chorus-backend
                dataKey: body.repository.full_name
              dest: spec.arguments.parameters.1.value
            - src:
                dependencyName: build-chorus-backend
                dataKey: body.after
              dest: spec.arguments.parameters.2.value
            - src:
                dependencyName: build-chorus-backend
                dataKey: body.ref
              dest: spec.arguments.parameters.3.value
            - src:
                dependencyName: build-chorus-backend
                dataKey: body.head_commit.id
              dest: spec.arguments.parameters.4.value
            - src:
                dependencyName: build-chorus-backend
                dataTemplate: '{{`{{ if hasPrefix "refs/tags/v" .Input.body.ref }}{{ .Input.body.ref | trimPrefix "refs/tags/v"  }}{{ else }}n/a{{ end }}`}}'
              dest: spec.arguments.parameters.5.value
            # Append text and commit id to dynamically assign workflow name.
            - src:
                dependencyName: build-chorus-backend
                dataTemplate: "build-chorus-backend-{{`{{ .Input.body.head_commit.id | substr 0 7 }}`}}"
              dest: metadata.generateName
              operation: prepend
            # Generate a nice title and description
            - src:
                dependencyName: build-chorus-backend
                dataTemplate: 'Release {{`{{ if hasPrefix "refs/tags/v" .Input.body.ref }}{{ .Input.body.ref | trimPrefix "refs/tags/v"  }}{{ end }}`}}'
              dest: metadata.annotations.workflows\.argoproj\.io/title
            - src:
                dependencyName: build-chorus-backend
                dataTemplate: '{{`{{ .Input.body.repository.full_name }}`}}'
              dest: metadata.annotations.workflows\.argoproj\.io/description

      retryStrategy:
        steps: 3
